<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    #container {
      position: absolute;
      overflow: visible;
    }
  </style>
</head>

<body>
  <div id="container"></div>
  <canvas></canvas>
  <button onclick="save()">保存</button>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const allX1 = 13323814.83741736;
    const allY1 = 3481248.01622007;
    const step = 3597.3176436740905;
    const size = 200;
    const canvas = document.querySelector('canvas');
    Object.assign(canvas, {
      width: 15 * size,
      height: 15 * size
    })
    Object.assign(canvas.style, {
      width: `${15 * size}px`,
      height: `${15 * size}px`
    })
    const ctx = canvas.getContext('2d');
    const addImage = (url, top, left) => {
      const image = new Image();
      Object.assign(image, {
        src: url,
        width: size,
        height: size,
      })
      Object.assign(image.style, {
        position: 'absolute',
        top: `${(22 - top) * size}px`,
        left: `${left * size}px`
      })
      document.querySelector('#container').appendChild(image);
    };
    const downloadImage = (url, top, left) => {
      const image = new Image();
      image.setAttribute('crossorigin', 'anonymous');
      image.onload = () => {
        const canvas = document.createElement('canvas');
        Object.assign(canvas, {
          width: size,
          height: size
        })
        const ctx = canvas.getContext('2d');
        ctx.drawImage(image, 0, 0, size, size);
        const blob = dataURLtoBlob(canvas.toDataURL());
        const objectURL = URL.createObjectURL(blob);
        const alink = document.createElement('a');
        alink.href = objectURL;
        alink.download = `${22 - top}-${left - 8}`;
        alink.click();
      }
      Object.assign(image, {
        src: url,
      })
    }
    const drawImage = (url, top, left) => {
      const image = new Image();
      image.setAttribute('crossorigin', 'anonymous');
      image.onload = () => {
        ctx.drawImage(image, (left - 8) * size, (22 - top) * size, size, size);
      }
      Object.assign(image, {
        src: url,
      })
    };
    const dataURLtoBlob = (dataURL) => {
      const array = dataURL.split(',');
      const mime = array[0].match(/:(.*?);/)[1];
      const string = atob(array[1]);
      let { length } = string;
      const uint8Array = new Uint8Array(length);
      while (length--) {
        uint8Array[length] = string.charCodeAt(length);
      }
      return new Blob([uint8Array], { type: mime });
    }
    const save = () => {
      const blob = dataURLtoBlob(canvas.toDataURL());
      const objectURL = URL.createObjectURL(blob);
      const alink = document.createElement('a');
      alink.href = objectURL;
      alink.download = '杭州控规';
      alink.click();
    }
    for (let i = 8; i < 23; i++) {
      for (let j = 8; j < 23; j++) {
        axios.get(`https://ditu.hangzhoumap.gov.cn:6443/arcgis/rest/services/KGDK/MapServer/export?bbox=${allX1 + j * step}%2C${allY1 + (i + 1) * step}%2C${allX1 + (j + 1) * step}%2C${allY1 + i * step}&size=${size}%2C${size}&dpi=1&format=png24&transparent=true&bboxSR=3857&imageSR=3857&f=json`).then(({ data }) => {
          addImage(data.href, i, j)
        })
      }
    }
  </script>
</body>

</html>