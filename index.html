<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script type="text/javascript"
          src="https://webapi.amap.com/maps?v=1.4.15&key=fcf51b643e722ea69e727d35606476c5"></script>
  <script src='./js/hangzhou.js'></script>
  <script src='./js/suzhou.js'></script>
  <script src='./js/shanghai.js'></script>
  <script src='./js/nanjing.js'></script>
  <script src='./js/wuxi.js'></script>
  <script src='./js/ningbo.js'></script>
  <script src='./js/beijing.js'></script>
  <script src='./js/tianjin.js'></script>
  <script src='./js/guangzhou.js'></script>
  <script src='./js/shenzhen.js'></script>
  <script src='./js/chengdu.js'></script>
  <script src='./js/chongqing.js'></script>
  <script src='./js/wuhan.js'></script>
  <script src='./js/xian.js'></script>
  <style>
    body {
      margin: 0;
    }

    #container {
      width: 3200px;
      height: 2400px;
    }

    #board {
      position: fixed;
      top: 0;
      left: 0;
      width: 400px;
      height: 47192.168.199.109 0px;
      background-color: #fff;
      z-index: 1000;
      border: 1px solid red;
    }

    #images {
      position: relative;
      width: 100;
      height: 300px;
    }

    #images>img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
  </style>
</head>

<body>
  <div id="container"></div>
  <div id="board">
    <p>城市
      <select onchange="changeCity()">
        <option value="shanghai">上海</option>
        <option value="hangzhou">杭州</option>
        <option value="suzhou">苏州</option>
        <option value="nanjing">南京</option>
        <option value="wuxi">无锡</option>
        <option value="ningbo">宁波</option>
        <option value="beijing">北京</option>
        <option value="tianjin">天津</option>
        <option value="guangzhou">广州</option>
        <option value="shenzhen">深圳</option>
        <option value="chengdu">成都</option>
        <option value="chongqing">重庆</option>
        <option value="wuhan">武汉</option>
        <option value="xian">西安</option>
      </select>
    </p>
    <p>marker尺寸 <input type="number" value="6" onchange="changeMarkerSize(event)" />像素</p>
    <p>缩放程度 <input type="number" value="12" onchange="changeScale(event)" /></p>
    <p>中心点经度 <input id="lng" type="number" value="121.43348" onchange="changeLng(event)" /></p>
    <p>中心点纬度 <input id="lat" type="number" value="31.18334" onchange="changeLat(event)" /></p>
    <div>
      <button onclick="draw()">重新渲染</button>
      <button onclick="save()">保存</button>
    </div>
    <p id="text"></p>
    <div id="images">
      <img id="image1" src="" alt="">
      <img id="image0" src="" alt="">
    </div>
  </div>

  <script type="text/javascript">
    let city = 'shanghai';
    let markerSize = 6;
    let scale = 12;
    let lat = 31.18334;
    let lng = 121.43348
    const dataURLs = [];

    const dataURLtoBlob = (dataURL) => {
      const array = dataURL.split(',');
      const mime = array[0].match(/:(.*?);/)[1];
      const string = atob(array[1]);
      let { length } = string;
      const uint8Array = new Uint8Array(length);
      while (length--) {
        uint8Array[length] = string.charCodeAt(length);
      }
      return new Blob([uint8Array], { type: mime });
    }

    const setText = (text) => {
      document.querySelector('#text').innerHTML = text;
    }

    const pointMap = {
      shanghai: [121.43348, 31.18334],
      hangzhou: [120.153576, 30.287459],
      suzhou: [120.619585, 31.299379],
      nanjing: [118.78, 32.07],
      wuxi: [120.301663, 31.574729],
      ningbo: [121.549792, 29.868388],
      beijing: [116.38974, 39.910919],
      tianjin: [117.429698, 39.244461],
      guangzhou: [113.280637, 23.125178],
      shenzhen: [114.085947, 22.547],
      chengdu: [104.065735, 30.659462],
      chongqing: [106.504962, 29.533155],
      wuhan: [114.298572, 30.584355],
      xian: [108.948024, 34.263161],
    }

    const changeCity = () => {
      document.querySelectorAll('option').forEach(option => {
        if (option.selected) {
          city = option.value;
          lng = pointMap[city][0];
          lat = pointMap[city][1];
          document.querySelector('#lng').value = lng;
          document.querySelector('#lat').value = lat;
        }
      })
    }

    const changeMarkerSize = ({ target }) => {
      markerSize = parseInt(target.value);
    }
    const changeScale = ({ target }) => {
      scale = parseInt(target.value);
    }

    const changeLng = ({ target }) => {
      lng = Number(target.value)
    }

    const changeLat = ({ target }) => {
      lat = Number(target.value)
    }

    const map = new AMap.Map('container', { showLabel: false });
    map.setMapStyle('amap://styles/grey');

    const draw = () => {
      setText('渲染中。。。');
      document.querySelector(`#image0`).src = '';
      document.querySelector(`#image1`).src = '';
      const container = document.querySelector('#container');

      map.clearMap();
      map.setCenter([lng, lat]);
      map.setZoom(scale);

      window[city].forEach(({ coordinates }, index) => {
        const circleMarker = new AMap.CircleMarker({
          center: [coordinates.longitude, coordinates.latitude],
          radius: markerSize,
          strokeWeight: 0,
          strokeOpacity: 0,
          fillColor: 'rgba(255,255,255,1)',
          fillOpacity: 1,
          zIndex: 10,
        })
        circleMarker.setMap(map);
      });

      setTimeout(() => {
        Array.from(document.querySelectorAll('canvas')).forEach((canvas, index) => {
          const dataURL = canvas.toDataURL('image/png');
          dataURLs[index] = dataURL;
          document.querySelector(`#image${index}`).src = dataURL;
        });
        setText(`已渲染完成，共${window[city].length}家店`)
      }, 3000)
    }

    const save = () => {
      dataURLs.forEach((dataURL, index) => {
        const blob = dataURLtoBlob(dataURL);
        const objectURL = URL.createObjectURL(blob);
        const alink = document.createElement('a');
        alink.href = objectURL;
        alink.download = `星巴克分布${city}${index}`;
        alink.click();
      })
    }

    draw()
  </script>
</body>

</html>